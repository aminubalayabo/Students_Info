<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Student Results Summary</title>  
    <style>  
        body {  
            font-family: Arial, sans-serif;  
        }  
        table {  
            border-collapse: collapse;  
            width: 100%;  
            margin-top: 20px;  
        }  
        th, td {  
            border: 1px solid #ddd;  
            padding: 8px;  
        }  
        th {  
            background-color: #f2f2f2;  
        }  
    </style>  
</head>  
<body>  

<h1>Student Results Summary</h1>  

<h2>Search by Admission Number</h2>  
<input type="text" id="admissionNumber" placeholder="Enter Admission Number">  
<button onclick="searchByAdmissionNumber()">Search</button>  

<h2>Search by Department</h2>  
<select id="departmentSelect">  
    <option value="">Select Department</option>  
    <option value="Accounting">Accounting</option>  
    <option value="Economics">Economics</option>  
    <option value="Zoology">Zoology</option>  
</select>  
<button onclick="filterByDepartment()">Filter</button>  

<h2>Filter by Session</h2>  
<select id="sessionSelect">  
    <option value="">Select Session</option>  
    <option value="2018/2019">2018/2019</option>  
    <option value="2020/2021">2020/2021</option>  
</select>  
<button onclick="filterBySession()">Search by Session</button>  

<button onclick="downloadCSV()">Download Results as CSV</button> <!-- Button to download CSV -->  
<div id="results"></div>  

<script>  
    const url = 'https://raw.githubusercontent.com/aminubalayabo/Students_Info/main/Student_Details/Details.txt';  
    let resultsData = []; // Variable to store fetched results  

    async function fetchStudentData() {  
        const response = await fetch(url);  
        const data = await response.text();  
        return parseData(data);  
    }  

    function parseData(data) {  
        const lines = data.trim().split('\n');  
        const header = lines[0].split(',');  
        const students = lines.slice(1).map(line => {  
            const values = line.split(',');  
            const student = {};  
            header.forEach((h, i) => {  
                student[h.trim()] = values[i].trim();  
            });  
            return student;  
        });  
        return students;  
    }  

    function searchByAdmissionNumber() {  
        const admissionNumber = document.getElementById("admissionNumber").value.trim();  
        if (admissionNumber) {  
            fetchStudentData().then(students => {  
                resultsData = students.filter(student => student.AdmissionNumber === admissionNumber);  
                displayResults(resultsData);  
            });  
        }  
    }  

    function filterByDepartment() {  
        const department = document.getElementById("departmentSelect").value;  
        if (department) {  
            fetchStudentData().then(students => {  
                resultsData = students.filter(student => student.Department === department);  
                displayResults(resultsData);  
            });  
        }  
    }  

    function filterBySession() {  
        const session = document.getElementById("sessionSelect").value;  
        if (session) {  
            fetchStudentData().then(students => {  
                resultsData = students.filter(student => student.Session === session);  
                displayResults(resultsData);  
            });  
        }  
    }  

    function displayResults(results) {  
        if (results.length === 0) {  
            document.getElementById('results').innerHTML = 'No results found.';  
            return;  
        }  

        let output = `<table>  
            <tr>  
                <th>Admission Number</th>  
                <th>Name</th>  
                <th>Department</th>  
                <th>Session</th>  
                <th>All Courses Registered</th>  
                <th>Total Units</th>  
                <th>CGPA</th>  
            </tr>`;  

        results.forEach(student => {  
            output += `<tr>  
                <td>${student.AdmissionNumber}</td>  
                <td>${student.Name}</td>  
                <td>${student.Department}</td>  
                <td>${student.Session}</td>  
                <td>${student.AllCourses}</td>  
                <td>${student.TotalUnits}</td>  
                <td>${student.CGPA}</td>  
            </tr>`;  
        });  

        output += `</table>`;  
        document.getElementById('results').innerHTML = output;  
    }  

    function downloadCSV() {  
        if (resultsData.length === 0) {  
            alert('No results to download.');  
            return;  
        }  

        // Create CSV headers  
        const headers = [  
            'Admission Number',  
            'Name',  
            'Department',  
            'Session',  
            'All Courses Registered',  
            'Total Units',  
            'CGPA'  
        ];  
        
        // Convert results to CSV format  
        const rows = resultsData.map(student => [  
            student.AdmissionNumber,  
            student.Name,  
            student.Department,  
            student.Session,  
            student.AllCourses,  
            student.TotalUnits,  
            student.CGPA  
        ]);  

        // Combine headers and rows  
        const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");  
        
        // Create a blob for the CSV content  
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });  
        const url = URL.createObjectURL(blob);  
        
        // Create a link to download the CSV  
        const link = document.createElement("a");  
        link.setAttribute("href", url);  
        link.setAttribute("download", "student_results.csv");  
        document.body.appendChild(link);  
        link.click();  
        document.body.removeChild(link);  
    }  

    window.onload = () => {  
        fetchStudentData(); // Preload data when the page loads  
    };  
</script>  

</body>  
</html>
